<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads Post Approval</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    keyframes: {
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' }
                        }
                    },
                    animation: {
                        slideDown: 'slideDown 0.3s ease',
                        slideUp: 'slideUp 0.3s ease'
                    }
                }
            }
        }
    </script>
    <style>
        /* Ensure modal overlay and sheet are properly styled */
        #generate-modal {
            transition: opacity 0.3s ease;
        }
        #modal-sheet {
            will-change: transform;
        }
        #modal-overlay {
            will-change: opacity;
        }
        /* Center modal on desktop */
        @media (min-width: 768px) {
            #modal-sheet {
                left: 50% !important;
                right: auto !important;
            }
        }
        /* Glassmorphism effect for all buttons - original greyish glass look */
        .btn {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18) !important;
            border-radius: 9999px !important;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9) !important;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Greyish shimmer effect that animates from left to right */
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.5s ease;
        }
        
        /* Hover state - greyish background with shimmer animation */
        .btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        /* Animate shimmer from left to right on hover */
        .btn:hover::before:not(:disabled) {
            left: 100%;
        }
        
        /* Active state */
        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Ensure content is above shimmer */
        .btn > * {
            position: relative;
            z-index: 1;
        }
        
        /* SVG icons */
        .btn svg {
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
        }
        
        /* Main content card container */
        .main-content-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            padding: 24px;
            margin-top: 16px;
            margin-bottom: 16px;
        }
        
        /* Gradient from purple to deep slate to dark grey (top left to bottom right) */
        .bg-gradient-slate {
            background: linear-gradient(135deg, #9e80bf 0%, #334155 50%, #475569 100%);
        }
        
        /* Override DaisyUI primary colors with gradient */
        .bg-primary {
            background: linear-gradient(135deg, #9e80bf 0%, #334155 50%, #475569 100%) !important;
        }
        
        /* Bottom navigation post button with gradient */
        .btn-nav-post {
            background: linear-gradient(135deg, #9e80bf 0%, #334155 50%, #475569 100%) !important;
            border: none !important;
            box-shadow: 0 4px 12px rgba(158, 128, 191, 0.4) !important;
        }
        
        .btn-nav-post:hover {
            background: linear-gradient(135deg, #8d6faf 0%, #2d3f52 50%, #3e4d5f 100%) !important;
            box-shadow: 0 6px 16px rgba(158, 128, 191, 0.5) !important;
        }
        
        /* Text color for gradient backgrounds */
        .text-primary-content,
        .text-on-gradient {
            color: rgba(255, 255, 255, 0.95) !important;
        }
        
        /* Badge with gradient */
        .badge-primary {
            background: linear-gradient(135deg, #9e80bf 0%, #334155 50%, #475569 100%) !important;
            color: rgba(255, 255, 255, 0.95) !important;
            border: none;
        }
        
        /* Loading spinner color */
        .text-primary {
            color: #64748b !important;
        }
        
        /* Border color for gradient elements */
        .border-primary {
            border-color: #475569 !important;
        }
        
        .border-primary-content {
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
    </style>
    
    <!-- DaisyUI Components -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="bg-base-200 min-h-screen">
    <!-- Bottom Sheet Modal for Generate Post -->
    <div id="generate-modal" class="fixed inset-0 z-[60] hidden">
        <!-- Overlay Backdrop -->
        <div id="modal-overlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity opacity-0" onclick="toggleGenerateForm()"></div>
        
        <!-- Bottom Sheet -->
        <div id="modal-sheet" class="absolute bottom-0 left-0 right-0 md:left-1/2 md:w-[50%] bg-base-100 rounded-t-3xl shadow-2xl transform transition-transform duration-300 ease-out h-2/3 max-h-[90vh] flex flex-col" style="transform: translateY(100%);">
            <!-- Drag Handle -->
            <div class="flex justify-center pt-3 pb-2">
                <div class="w-12 h-1.5 bg-base-300 rounded-full"></div>
    </div>

            <!-- Header -->
            <div class="flex justify-between items-center px-4 sm:px-6 lg:px-8 pb-4 border-b border-base-300">
                <h2 class="text-xl font-bold">Generate New Post</h2>
                <button onclick="toggleGenerateForm()" class="btn btn-sm btn-circle btn-ghost">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
        </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-4 sm:px-6 lg:px-8 py-4">
                <!-- Tabs -->
                <div class="tabs tabs-boxed mb-4">
                    <a class="tab tab-active" onclick="switchTab('connection', this)">Connection</a>
                    <a class="tab" onclick="switchTab('analysis', this)">Analysis</a>
                    <a class="tab" onclick="switchTab('briefs', this)">Briefs</a>
                </div>

                <!-- Connection Tab -->
                <div id="tab-connection" class="block">
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-semibold">Connection Type (optional)</span>
                        </label>
                        <input type="text" id="connection-type" placeholder="e.g., founders, developers, SMBs" class="input input-bordered" />
                        <label class="label">
                            <span class="label-text-alt">Leave empty for general connection post</span>
                        </label>
                    </div>
                    <button class="btn btn-primary btn-block rounded-full" onclick="generatePost('connection')">Generate Connection Post</button>
                </div>

                <!-- Analysis Tab -->
                <div id="tab-analysis" class="hidden">
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-semibold">Topic (optional)</span>
                        </label>
                        <input type="text" id="analysis-topic" placeholder="e.g., software development" class="input input-bordered" />
                        <label class="label">
                            <span class="label-text-alt">Leave empty for general post matching your style</span>
                        </label>
                    </div>
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-semibold">Posts to Analyze</span>
                        </label>
                        <input type="number" id="analysis-limit" value="25" min="1" max="100" class="input input-bordered" />
                        <label class="label">
                            <span class="label-text-alt">Number of past posts to analyze (default: 25)</span>
                        </label>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="generatePost('analysis')">Generate from Analysis</button>
                </div>

                <!-- Briefs Tab -->
                <div id="tab-briefs" class="hidden">
                    <!-- Collapsible Status Filter -->
                    <div class="mb-4">
                        <button
                            type="button"
                            onclick="toggleBriefsFilter()"
                            class="text-xs text-base-content/60 hover:text-base-content/80 flex items-center gap-1 mb-2 transition-all"
                        >
                            <svg id="filter-icon" class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span id="filter-toggle-text">Show filter</span>
                        </button>
                        <div id="briefs-filter-section" class="hidden">
                            <div class="form-control mb-3">
                                <label class="label py-1">
                                    <span class="label-text text-xs text-base-content/70">Status Filter (optional)</span>
                                </label>
                                <input
                                    type="text"
                                    id="briefs-status"
                                    placeholder="e.g., Ready"
                                    class="input input-bordered input-sm"
                                />
                                <label class="label py-1">
                                    <span class="label-text-alt text-xs text-base-content/50">Filter briefs by status</span>
                                </label>
                            </div>
                            
                            <div class="form-control mb-3">
                                <label class="label py-1">
                                    <span class="label-text text-xs text-base-content/70">Post Type Filter (optional)</span>
                                </label>
                                <select
                                    id="briefs-post-type"
                                    multiple
                                    class="select select-bordered select-sm h-24"
                                    size="3"
                                >
                                    <option value="">-- Select post types --</option>
                                </select>
                                <label class="label py-1">
                                    <span class="label-text-alt text-xs text-base-content/50">Hold Ctrl/Cmd to select multiple</span>
                                </label>
                            </div>
                            
                            <div class="form-control mb-3">
                                <label class="label py-1">
                                    <span class="label-text text-xs text-base-content/70">Platform Filter (optional)</span>
                                </label>
                                <select
                                    id="briefs-platform"
                                    class="select select-bordered select-sm"
                                >
                                    <option value="">-- Select platform --</option>
                                    <option value="Threads">Threads</option>
                                    <option value="Twitter">Twitter</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Instagram">Instagram</option>
                                    <option value="Facebook">Facebook</option>
                                </select>
                                <label class="label py-1">
                                    <span class="label-text-alt text-xs text-base-content/50">Filter briefs by platform</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Main Brief Selection -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-semibold">Select Brief</span>
                        </label>
                        <select id="briefs-select" class="select select-bordered w-full">
                            <option value="">Loading briefs...</option>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">Choose a brief to generate a post from</span>
                        </label>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="generatePost('briefs')">Generate from Briefs</button>
                </div>

                <div id="generate-status" class="alert mt-4 hidden"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation - Tailwind styled -->
            <div class="fixed bottom-3 left-0 right-0 bg-[#2a2a2a] rounded-full py-1 px-3 flex justify-around items-center z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] mx-2 md:left-1/2 md:-translate-x-1/2 md:w-[calc(100%-16px)] md:max-w-[600px] md:mx-0 lg:px-6">
        <!-- Home Button (Active) -->
        <button class="flex flex-col items-center justify-center gap-0.5 bg-transparent border-none text-gray-400 cursor-pointer py-1 px-3 rounded-full transition-all duration-200 relative min-w-[50px] bg-gray-700 text-white hover:bg-[rgba(55,65,81,0.5)]" onclick="window.location.href='/'">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            <span class="text-[10px] font-medium leading-tight">Home</span>
        </button>
        
        <!-- Pending Posts Button -->
        <button class="flex items-center justify-center bg-transparent border-none text-gray-400 cursor-pointer p-2 rounded-full transition-all duration-200 min-w-10 min-h-10 hover:text-white hover:bg-[rgba(55,65,81,0.3)]" onclick="window.location.href='/posts'" title="Pending Posts">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
            </svg>
        </button>
        
        <!-- Generate Post Button (Gradient Plus) -->
        <button class="btn-nav-post flex items-center justify-center text-white cursor-pointer w-[44px] h-[44px] rounded-full transition-all duration-200 relative z-10 hover:scale-105 active:scale-95" onclick="toggleGenerateForm()" title="Generate Post">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>
            </div>

            <!-- Full-width background with centered content container (Threads-style) -->
            <div class="w-full min-h-screen">
                <div class="w-full max-w-[600px] mx-auto px-4 sm:px-6 lg:px-8 pb-32">
            <!-- Main Content Card -->
            <div class="main-content-card">
        <!-- Header -->
        <div class="py-6 px-1">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-12">
                            <span class="text-lg font-bold">TS</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-base-content/70">Welcome back!</p>
                        <p class="font-semibold text-base">Devin</p>
                    </div>
                </div>
                <button class="btn btn-ghost btn-circle" onclick="showSettings()" title="Settings">
                    <div class="indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="badge badge-xs badge-primary indicator-item"></span>
                    </div>
                </button>
            </div>
            <h2 class="text-xl mb-4 font-semibold" id="dynamic-message">Ready to generate a new post?</h2>
            <button id="generate-btn" class="btn btn-primary btn-block rounded-full" onclick="toggleGenerateForm()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Generate Post
            </button>
        </div>

        <!-- Calendar View -->
        <div id="calendar-container" class="mb-4">
            <!-- Calendar Header - Days of Week -->
            <div class="p-4 mb-2">
                <!-- Navigation Arrows and Current Day Display -->
                <div class="flex justify-between items-center mb-3">
                    <button id="prev-day-btn" class="btn btn-ghost btn-sm btn-circle" onclick="navigateDay(-1)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div id="week-range" class="text-sm font-medium text-base-content/70">
                        <!-- Current day will be displayed here -->
                    </div>
                    <button id="next-day-btn" class="btn btn-ghost btn-sm btn-circle" onclick="navigateDay(1)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <!-- Day Labels Row -->
                <div class="flex justify-between items-center mb-2">
                    <div id="day-labels" class="flex gap-1 w-full">
                        <!-- Day labels will be dynamically generated -->
                    </div>
                </div>
                <!-- Calendar Dates - Single Row -->
                <div id="calendar-dates" class="flex justify-between items-center">
                    <!-- Dates will be dynamically generated -->
                </div>
            </div>

            <!-- Scrollable Calendar Timeline -->
            <div class="overflow-hidden">
                <div class="flex overflow-y-auto" style="height: 1152px;">
                    <!-- Time Axis (Left Side) -->
                    <div id="time-axis" class="w-20 flex-shrink-0 border-r border-base-300 pt-2">
                        <!-- Time labels will be dynamically generated -->
                    </div>

                    <!-- Calendar Grid (Right Side) - Single Day View -->
                    <div class="flex-1 relative">
                        <!-- Single Day Column -->
                        <div class="absolute inset-0 border-r border-base-300/30"></div>

                        <!-- Event Cards Container -->
                        <div id="calendar-events" class="relative h-full p-2">
                            <!-- Events will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
                </div>
            </div>
        </div>

    <script>
        const API_BASE = window.location.origin;

        // Calendar functionality
        let selectedDate = new Date();
        let calendarStartDate = new Date(); // Start from current day
        
        function initializeCalendar() {
            // Reset to current day on initialization
            calendarStartDate = new Date();
            calendarStartDate.setHours(0, 0, 0, 0);
            selectedDate = new Date(calendarStartDate);
            selectedDate.setHours(0, 0, 0, 0);
            
            generateTimeAxis();
            updateCalendarDates();
            loadCalendarPosts();
        }

        function navigateDay(days) {
            selectedDate.setDate(selectedDate.getDate() + days);
            selectedDate.setHours(0, 0, 0, 0);
            updateCalendarDates();
            loadCalendarPosts();
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            selectedDate.setHours(0, 0, 0, 0);
            updateCalendarDates();
            loadCalendarPosts();
        }

        function updateCalendarDates() {
            // Update selected date display
            const weekRangeEl = document.getElementById('week-range');
            if (weekRangeEl) {
                const dateString = selectedDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                weekRangeEl.textContent = dateString;
            }
            
            // Update day labels and dates - show 7 days for selection but only display selected day
            const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayLabelsContainer = document.getElementById('day-labels');
            const datesContainer = document.getElementById('calendar-dates');
            
            if (dayLabelsContainer && datesContainer) {
                // Calculate the week containing the selected date
                const selectedDayOfWeek = selectedDate.getDay();
                const weekStart = new Date(selectedDate);
                weekStart.setDate(selectedDate.getDate() - selectedDayOfWeek);
                weekStart.setHours(0, 0, 0, 0);
                
                dayLabelsContainer.innerHTML = '';
                datesContainer.innerHTML = '';
                
                // Show 7 days for navigation
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dayNum = date.getDate();
                    const dayOfWeek = date.getDay();
                    const dayLabel = dayLabels[dayOfWeek];
                    const isSelected = date.toDateString() === selectedDate.toDateString();
                    const isToday = date.toDateString() === new Date().toDateString();
                    
                    // Create day label
                    const labelDiv = document.createElement('div');
                    labelDiv.className = `flex-1 text-center text-xs font-medium ${isSelected ? 'text-primary font-semibold' : 'text-base-content/60'}`;
                    labelDiv.textContent = dayLabel;
                    dayLabelsContainer.appendChild(labelDiv);
                    
                    // Create date button (clickable)
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'flex-1 text-center';
                    
                    const dateButton = document.createElement('button');
                    dateButton.className = `w-10 h-10 mx-auto rounded-full flex items-center justify-center text-sm font-semibold transition-all cursor-pointer ${
                        isSelected 
                            ? 'bg-primary text-primary-content shadow-md scale-110' 
                            : isToday
                            ? 'bg-base-300 text-base-content hover:bg-base-300/80'
                            : 'text-base-content/70 hover:bg-base-200 hover:text-base-content'
                    }`;
                    dateButton.textContent = dayNum;
                    dateButton.onclick = () => selectDate(date);
                    dateButton.title = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                    
                    dateDiv.appendChild(dateButton);
                    datesContainer.appendChild(dateDiv);
                }
            }
        }

        function generateTimeAxis() {
            const timeAxis = document.getElementById('time-axis');
            timeAxis.innerHTML = '';
            
            // Generate time labels from 6 AM to 5 AM next day (24 hours)
            const times = [];
            // Start from 6 AM (06:00) to 11 PM (23:00)
            for (let hour = 6; hour < 24; hour++) {
                times.push({ hour, label: formatHour(hour) });
            }
            // Continue from midnight to 5 AM next day (exclude 6 AM to avoid duplication)
            for (let hour = 0; hour < 6; hour++) {
                times.push({ hour, label: formatHour(hour) });
            }
            
            times.forEach((time, index) => {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'text-xs text-base-content/50 font-medium px-2';
                timeDiv.style.height = '48px';
                timeDiv.style.display = 'flex';
                timeDiv.style.alignItems = 'flex-start';
                timeDiv.style.paddingTop = '4px';
                timeDiv.textContent = time.label;
                timeAxis.appendChild(timeDiv);
            });
        }

        function formatHour(hour) {
            if (hour === 0) return '12 AM';
            if (hour < 12) return `${hour} AM`;
            if (hour === 12) return '12 PM';
            return `${hour - 12} PM`;
        }

        function getTimePosition(timeString) {
            // Convert time string to position in pixels
            // Each hour = 48px
            const date = new Date(timeString);
            const hours = date.getHours();
            const minutes = date.getMinutes();
            
            // Calculate position: start from 6 AM (06:00) = 0px
            // Window spans 6 AM to 5:59 AM next day (24 hours)
            let hourDiff;
            if (hours >= 6) {
                // Same day: 6 AM to 11:59 PM
                hourDiff = hours - 6;
            } else {
                // Next day: 12 AM to 5:59 AM
                hourDiff = (24 - 6) + hours; // Hours from 6 AM to midnight + hours from midnight
            }
            
            const position = (hourDiff * 48) + (minutes / 60 * 48);
            // Clamp to 24-hour window (0 to 1152px)
            return Math.max(0, Math.min(1152, position));
        }

        function getDayIndex(dateString) {
            const postDate = new Date(dateString);
            const postDateOnly = new Date(postDate);
            postDateOnly.setHours(0, 0, 0, 0);
            
            // Use calendarStartDate instead of start of week
            const calendarStart = new Date(calendarStartDate);
            calendarStart.setHours(0, 0, 0, 0);
            
            const diffTime = postDateOnly - calendarStart;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Clamp to valid day index (0-6) for the current 7-day view
            return Math.max(0, Math.min(6, diffDays));
        }

        async function loadCalendarPosts() {
            try {
                // Get all posts including past published ones for calendar
                const response = await fetch(`${API_BASE}/api/posts/pending?include_all=true`);
                const data = await response.json();
                
                const eventsContainer = document.getElementById('calendar-events');
                eventsContainer.innerHTML = '';
                
                if (data.posts && data.posts.length > 0) {
                    // Calculate date range for selected day only
                    const startDate = new Date(selectedDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(selectedDate);
                    endDate.setHours(23, 59, 59, 999);
                    
                    // Filter posts for the selected day
                    const filteredPosts = data.posts.filter(post => {
                        // Use scheduled_at if available, otherwise use published_at or created_at
                        const displayDate = post.scheduled_at || post.published_at || post.created_at;
                        const postDate = new Date(displayDate);
                        return postDate >= startDate && postDate <= endDate;
                    });
                    
                    filteredPosts.forEach(post => {
                        const eventCard = createEventCard(post);
                        if (eventCard) {
                            eventsContainer.appendChild(eventCard);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading calendar posts:', error);
            }
        }

        function createEventCard(post) {
            // Use scheduled_at if available, otherwise use published_at or created_at
            const displayDate = post.scheduled_at || post.published_at || post.created_at;
            const postDate = new Date(displayDate);
            const topPosition = getTimePosition(displayDate);
            
            // Determine if post is in the past
            const now = new Date();
            const isPast = postDate < now;
            const isScheduled = post.scheduled_at && post.status === 'approved';
            const isPublished = post.status === 'published';
            
            // Determine card color and styling
            let cardBgClass = 'bg-base-200';
            let textColorClass = 'text-base-content';
            let opacityClass = '';
            
            if (isPublished) {
                cardBgClass = 'bg-primary';
                textColorClass = 'text-primary-content';
            } else if (isScheduled) {
                cardBgClass = 'bg-accent';
                textColorClass = 'text-accent-content';
            } else if (isPast) {
                // Grey out past posts
                opacityClass = 'opacity-50';
                cardBgClass = 'bg-base-300';
                textColorClass = 'text-base-content/60';
            }
            
            // Get mode label
            const modeLabel = post.mode.charAt(0).toUpperCase() + post.mode.slice(1);
            
            // Status badge
            let statusBadge = '';
            if (isScheduled) {
                statusBadge = '<span class="badge badge-xs badge-accent ml-2">Scheduled</span>';
            } else if (isPublished) {
                statusBadge = '<span class="badge badge-xs badge-primary ml-2">Published</span>';
            }
            
            // Truncate post text for display (use first line or first 50 chars)
            const postLines = post.post_text.split('\n');
            const displayText = postLines[0].length > 50 
                ? postLines[0].substring(0, 50) + '...'
                : postLines[0];
            
            // Format time for display
            const timeString = postDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            const card = document.createElement('div');
            card.className = `absolute rounded-lg shadow-md p-3 ${cardBgClass} ${textColorClass} ${opacityClass} cursor-pointer hover:shadow-lg transition-all hover:scale-[1.02]`;
            // Full width since we're only showing one day
            card.style.left = '0.5%';
            card.style.width = '99%';
            card.style.top = `${topPosition}px`;
            card.style.minHeight = '100px';
            card.onclick = () => window.location.href = `/approve/${post.id}`;
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-medium opacity-80">${modeLabel}${statusBadge}</span>
                    <a href="/approve/${post.id}" class="text-xs font-medium opacity-80 hover:opacity-100" onclick="event.stopPropagation()">Details ></a>
                </div>
                <h3 class="font-bold text-base mb-1 leading-tight">${escapeHtml(displayText)}</h3>
                <p class="text-xs opacity-70 mb-3">Threads Automation</p>
                <div class="flex items-center justify-between">
                    <button class="btn btn-sm btn-ghost rounded-full px-3 h-7 min-h-0 text-xs ${textColorClass} border ${textColorClass === 'text-primary-content' ? 'border-primary-content/30' : 'border-base-300'}" onclick="event.stopPropagation()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ${timeString}
                    </button>
                    <div class="flex -space-x-2">
                        <div class="w-6 h-6 rounded-full bg-gradient-slate opacity-30 border-2 ${textColorClass === 'text-primary-content' ? 'border-primary' : 'border-base-100'}"></div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function toggleGenerateForm() {
            const modal = document.getElementById('generate-modal');
            const sheet = document.getElementById('modal-sheet');
            const overlay = document.getElementById('modal-overlay');
            
            if (modal && sheet && overlay) {
                if (modal.classList.contains('hidden')) {
                    // Open modal
                    modal.classList.remove('hidden');
                    // Prevent body scroll
                    document.body.style.overflow = 'hidden';
                    // Trigger animation
                    setTimeout(() => {
                        // Check if we're on desktop (md breakpoint) to add translateX for centering
                        const isDesktop = window.innerWidth >= 768;
                        if (isDesktop) {
                            sheet.style.transform = 'translate(-50%, 0)';
                        } else {
                            sheet.style.transform = 'translateY(0)';
                        }
                        overlay.style.opacity = '1';
                    }, 10);
                } else {
                    // Close modal
                    const isDesktop = window.innerWidth >= 768;
                    if (isDesktop) {
                        sheet.style.transform = 'translate(-50%, 100%)';
                    } else {
                        sheet.style.transform = 'translateY(100%)';
                    }
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        document.body.style.overflow = '';
                    }, 300);
                }
            }
        }

        function switchTab(tabName, element) {
            // Hide all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('block');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('tab-active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            selectedTab.classList.remove('hidden');
            selectedTab.classList.add('block');
            element.classList.add('tab-active');

            // Load briefs when switching to briefs tab
            if (tabName === 'briefs') {
                loadBriefs();
            }
        }

        function toggleBriefsFilter() {
            const filterSection = document.getElementById('briefs-filter-section');
            const filterIcon = document.getElementById('filter-icon');
            const toggleText = document.getElementById('filter-toggle-text');

            if (filterSection.classList.contains('hidden')) {
                filterSection.classList.remove('hidden');
                toggleText.textContent = 'Hide filter';
                filterIcon.style.transform = 'rotate(180deg)';
            } else {
                filterSection.classList.add('hidden');
                toggleText.textContent = 'Show filter';
                filterIcon.style.transform = 'rotate(0deg)';
            }
        }

        async function loadBriefs() {
            const statusFilter = document.getElementById('briefs-status').value.trim();
            const postTypeSelect = document.getElementById('briefs-post-type');
            const platformSelect = document.getElementById('briefs-platform');
            const select = document.getElementById('briefs-select');

            if (!select) return;

            select.innerHTML = '<option value="">Loading briefs...</option>';
            select.disabled = true;

            try {
                const params = new URLSearchParams();
                if (statusFilter) {
                    params.append('status_filter', statusFilter);
                }
                
                // Get selected post types (multi-select)
                if (postTypeSelect) {
                    const selectedPostTypes = Array.from(postTypeSelect.selectedOptions)
                        .map(option => option.value)
                        .filter(value => value); // Remove empty values
                    if (selectedPostTypes.length > 0) {
                        params.append('post_type', selectedPostTypes.join(','));
                    }
                }
                
                // Get selected platform
                if (platformSelect && platformSelect.value) {
                    params.append('platform', platformSelect.value);
                }
                
                params.append('limit', '50'); // Load up to 50 briefs

                const response = await fetch(`${API_BASE}/api/briefs?${params}`);
                if (!response.ok) {
                    throw new Error('Failed to load briefs');
                }

                const briefs = await response.json();

                if (briefs.length === 0) {
                    select.innerHTML = '<option value="">No briefs found</option>';
                } else {
                    select.innerHTML = '<option value="">-- Select a brief --</option>';
                    
                    // Collect unique post types and platforms for filter dropdowns
                    const uniquePostTypes = new Set();
                    const uniquePlatforms = new Set();
                    
                    briefs.forEach(brief => {
                        const option = document.createElement('option');
                        option.value = brief.page_id;
                        const topic = brief.topic || 'Untitled';
                        const pillar = brief.pillar ? ` (${brief.pillar})` : '';
                        const status = brief.status ? ` [${brief.status}]` : '';
                        option.textContent = `${topic}${pillar}${status}`;
                        select.appendChild(option);
                        
                        // Collect post types and platforms
                        if (brief.post_type && Array.isArray(brief.post_type)) {
                            brief.post_type.forEach(pt => uniquePostTypes.add(pt));
                        }
                        if (brief.platforms && Array.isArray(brief.platforms)) {
                            brief.platforms.forEach(p => uniquePlatforms.add(p));
                        }
                    });
                    
                    // Update post type filter options if not already populated
                    if (postTypeSelect && postTypeSelect.options.length <= 1) {
                        uniquePostTypes.forEach(postType => {
                            const option = document.createElement('option');
                            option.value = postType;
                            option.textContent = postType;
                            postTypeSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                select.innerHTML = '<option value="">Error loading briefs</option>';
                console.error('Error loading briefs:', error);
            } finally {
                select.disabled = false;
            }
        }

        async function generatePost(mode) {
            const statusDiv = document.getElementById('generate-status');
            statusDiv.classList.remove('hidden');
            statusDiv.className = 'alert alert-info mt-4 flex';
            statusDiv.innerHTML = `
                <span class="loading loading-spinner loading-sm"></span>
                <span>Generating post... This may take a moment.</span>
            `;

            let requestBody = {};
            let endpoint = '';

            try {
                if (mode === 'connection') {
                    endpoint = '/api/generate/connection';
                    const connectionType = document.getElementById('connection-type').value.trim();
                    if (connectionType) {
                        requestBody = { connection_type: connectionType };
                    }
                } else if (mode === 'analysis') {
                    endpoint = '/api/generate/analysis';
                    const topic = document.getElementById('analysis-topic').value.trim();
                    const limit = parseInt(document.getElementById('analysis-limit').value) || 25;
                    requestBody = { limit: limit };
                    if (topic) {
                        requestBody.topic = topic;
                    }
                } else if (mode === 'briefs') {
                    endpoint = '/api/generate/briefs';
                    const briefId = document.getElementById('briefs-select').value;
                    const statusFilter = document.getElementById('briefs-status').value.trim();

                    if (!briefId) {
                        statusDiv.className = 'alert alert-error mt-4';
                        statusDiv.innerHTML = '❌ Please select a brief';
                        return;
                    }

                    requestBody = { brief_id: briefId };
                    if (statusFilter) {
                        requestBody.status_filter = statusFilter;
                    }
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.className = 'alert alert-success mt-4';
                    statusDiv.innerHTML = `✅ Post generated successfully! <a href="${data.approval_url}" class="link link-hover font-semibold">Review it here</a>`;
                    
                    // Redirect to posts page after a short delay
                    setTimeout(() => {
                        toggleGenerateForm(); // Close form
                        window.location.href = '/posts';
                    }, 2000);
                } else {
                    statusDiv.className = 'alert alert-error mt-4';
                    statusDiv.innerHTML = `❌ Error: ${data.detail || 'Failed to generate post'}`;
                }
            } catch (error) {
                statusDiv.className = 'alert alert-error mt-4';
                statusDiv.innerHTML = `❌ Error: ${error.message}`;
            }
        }

        function showDocuments() {
            alert('Documents feature coming soon!');
        }

        function showSettings() {
            alert('Settings feature coming soon!');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize calendar on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendar();

            // Add event listeners to reload briefs when filters change
            const briefsStatusInput = document.getElementById('briefs-status');
            const briefsPostTypeSelect = document.getElementById('briefs-post-type');
            const briefsPlatformSelect = document.getElementById('briefs-platform');
            
            // Debounce function for status filter
            let debounceTimer;
            if (briefsStatusInput) {
                briefsStatusInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        loadBriefs();
                    }, 500); // Wait 500ms after user stops typing
                });
            }
            
            // Reload when post type selection changes
            if (briefsPostTypeSelect) {
                briefsPostTypeSelect.addEventListener('change', function() {
                    loadBriefs();
                });
            }
            
            // Reload when platform selection changes
            if (briefsPlatformSelect) {
                briefsPlatformSelect.addEventListener('change', function() {
                    loadBriefs();
                });
            }
        });

        // Dynamic messages that change on each reload
        const dynamicMessages = [
            "Ready to generate a new post?",
            "What's on your mind today?",
            "Time to create something amazing!",
            "Let's craft your next post!",
            "Ready to share your thoughts?",
            "What story will you tell today?",
            "Let's make your voice heard!",
            "Time to engage your audience!",
            "Ready to connect with your community?",
            "What message do you want to share?"
        ];

        // Load user info and set dynamic message
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/user/info`);
                if (!response.ok) {
                    throw new Error('User info endpoint not available');
                }
                const userData = await response.json();
                
                // Update username if element exists
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    const username = userData.username || "User";
                    const displayName = username.charAt(0).toUpperCase() + username.slice(1);
                    userNameElement.textContent = displayName;
                }
                
                // Set dynamic message
                const dynamicMessageElement = document.getElementById('dynamic-message');
                if (dynamicMessageElement) {
                    const randomMessage = dynamicMessages[Math.floor(Math.random() * dynamicMessages.length)];
                    dynamicMessageElement.textContent = randomMessage;
                }
            } catch (error) {
                // Silently fail - just set the dynamic message
                console.log('User info not available, using default message');
                const dynamicMessageElement = document.getElementById('dynamic-message');
                if (dynamicMessageElement) {
                    const randomMessage = dynamicMessages[Math.floor(Math.random() * dynamicMessages.length)];
                    dynamicMessageElement.textContent = randomMessage;
                }
            }
        }

        // Call on page load
        loadUserInfo();        
    </script>
</body>
</html>
